name: Build VKD3D-Proton x86_64

on:
  workflow_dispatch:
    inputs:
      VERSION:
        description: "Version (empty = latest)"
        required: false
        default: ""
  workflow_call:
    inputs:
      VERSION:
        type: string
        required: false
        default: ""
    outputs:
      version:
        value: ${{ jobs.build.outputs.version }}
      commit:
        value: ${{ jobs.build.outputs.commit }}
      artifact_name:
        value: ${{ jobs.build.outputs.artifact_name }}

concurrency:
  group: build-x86_64-${{ github.ref }}-${{ inputs.VERSION || 'latest' }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      commit: ${{ steps.clone.outputs.COMMIT }}
      artifact_name: ${{ steps.package.outputs.ARTIFACT_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git meson ninja-build curl jq python3 \
            glslang-tools spirv-tools zstd \
            gcc-mingw-w64-x86-64 gcc-mingw-w64-i686 \
            g++-mingw-w64-x86-64 g++-mingw-w64-i686 \
            mingw-w64 mingw-w64-tools binutils-mingw-w64
          sudo update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix 2>/dev/null || true
          sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix 2>/dev/null || true
          sudo update-alternatives --set i686-w64-mingw32-gcc /usr/bin/i686-w64-mingw32-gcc-posix 2>/dev/null || true
          sudo update-alternatives --set i686-w64-mingw32-g++ /usr/bin/i686-w64-mingw32-g++-posix 2>/dev/null || true

      - name: Get Version
        id: version
        run: |
          if [[ -n "${{ inputs.VERSION }}" ]]; then
            VER="${{ inputs.VERSION }}"
            [[ "$VER" =~ ^v ]] || VER="v$VER"
          else
            VER=$(curl -sL https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | jq -r '.tag_name // empty')
            [[ -z "$VER" ]] && VER=$(curl -sL https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases | jq -r '.[0].tag_name')
          fi
          echo "TAG=$VER" >> $GITHUB_ENV
          echo "VERSION=${VER#v}" >> $GITHUB_OUTPUT

      - name: Clone Source
        id: clone
        run: |
          git clone --branch ${{ env.TAG }} --depth 1 https://github.com/HansKristian-Work/vkd3d-proton.git src
          cd src
          git submodule update --init --recursive --depth 1 --jobs 4
          COMMIT=$(git rev-parse --short=8 HEAD)
          COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")
          echo "COMMIT=$COMMIT" >> $GITHUB_OUTPUT
          echo "COMMIT=$COMMIT" >> $GITHUB_ENV
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV

      - name: Apply Patches
        run: python3 scripts/apply-patches.py src --arch x86_64 --report

      - name: Upload Patch Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: patch-report-x86_64-${{ steps.version.outputs.VERSION }}-${{ steps.clone.outputs.COMMIT }}
          path: patch-report.txt
          retention-days: 7

      - name: Build
        run: |
          cd src
          chmod +x ./package-release.sh
          export CFLAGS="-O3 -march=x86-64 -mtune=generic -msse4.2 -mavx -mavx2 -mfma -ffast-math -DNDEBUG"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-s -Wl,--gc-sections"
          bash ./package-release.sh ${{ env.TAG }} ../out --no-package

      - name: Verify Build
        run: |
          SRC=$(find out -maxdepth 1 -type d -name "vkd3d-proton-*" | head -1)
          [[ -z "$SRC" ]] && { echo "Build output not found"; exit 1; }
          for arch in x64 x86; do
            for dll in d3d12.dll d3d12core.dll; do
              DLL_PATH="$SRC/$arch/$dll"
              if [[ ! -f "$DLL_PATH" ]]; then
                echo "Missing: $DLL_PATH"
                exit 1
              fi
              echo "$DLL_PATH: $(stat -c%s "$DLL_PATH") bytes"
            done
          done
          echo "SRC_PATH=$SRC" >> $GITHUB_ENV

      - name: Package
        id: package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          COMMIT="${{ env.COMMIT }}"
          ARTIFACT_NAME="vkd3d-proton-${VERSION}-${COMMIT}"

          mkdir -p pkg/system32 pkg/syswow64
          cp "${{ env.SRC_PATH }}/x64/"*.dll pkg/system32/
          cp "${{ env.SRC_PATH }}/x86/"*.dll pkg/syswow64/

          cd pkg
          sha256sum system32/*.dll syswow64/*.dll > checksums.txt

          cat > profile.json << EOF
          {
            "type": "VKD3D",
            "versionName": "VKD3D-Proton ${VERSION}",
            "versionCode": ${{ env.COMMIT_COUNT }},
            "description": "VKD3D-Proton ${VERSION} (${COMMIT})",
            "files": [
              {"source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll"}
            ]
          }
          EOF

          tar --zstd -cf "../${ARTIFACT_NAME}.wcp" .
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.ARTIFACT_NAME }}
          path: |
            ${{ steps.package.outputs.ARTIFACT_NAME }}.wcp
            pkg/checksums.txt
          retention-days: 30
