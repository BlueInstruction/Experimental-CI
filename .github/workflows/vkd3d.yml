name: Build VKD3D-Proton for Winlator

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-vkd3d:
    runs-on: ubuntu-24.04
    steps:
      - name: Get Latest Version Info
        id: version
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Clone and Build
        uses: Joshua-Ashton/arch-mingw-github-action@v8
        with:
          command: |
            LATEST_TAG=$(curl -s https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
            
            git clone --recursive --branch "$LATEST_TAG" https://github.com/HansKristian-Work/vkd3d-proton.git
            cd vkd3d-proton
            
            ./package-release.sh "$LATEST_TAG" build --no-package

      - name: Package for Winlator
        run: |
          cd vkd3d-proton
          
          LATEST_TAG=$(curl -s https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
          VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
          SHA=$(git rev-parse --short HEAD)
          
          BUILD_DIR=$(find build -maxdepth 1 -type d -name "vkd3d-proton-*" | head -1)
          
          mkdir -p winlator_package/system32
          mkdir -p winlator_package/syswow64
          
          cp "$BUILD_DIR/x64/"*.dll winlator_package/system32/
          cp "$BUILD_DIR/x86/"*.dll winlator_package/syswow64/
          
          VERSION_CODE=$((RANDOM % 3))
          
          cat > winlator_package/profile.json << EOF
          {
            "type": "VKD3D",
            "versionName": "${VERSION}-${SHA}",
            "versionCode": ${VERSION_CODE},
            "description": "vkd3d-proton",
            "files": [
              {
                "source": "system32/d3d12.dll",
                "target": "\${system32}/d3d12.dll"
              },
              {
                "source": "system32/d3d12core.dll",
                "target": "\${system32}/d3d12core.dll"
              },
              {
                "source": "syswow64/d3d12.dll",
                "target": "\${syswow64}/d3d12.dll"
              },
              {
                "source": "syswow64/d3d12core.dll",
                "target": "\${syswow64}/d3d12core.dll"
              }
            ]
          }
          EOF
          
          ARCHIVE_NAME="vkd3d-proton-${VERSION}-${SHA}.wcp"
          
          cd winlator_package
          zip -r "../$ARCHIVE_NAME" .
          
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vkd3d-proton-winlator
          path: vkd3d-proton/*.wcp
          if-no-files-found: error
