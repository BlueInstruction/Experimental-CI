name: VKD3D

on:
  schedule:
    - cron: "0 21 * * *"
  workflow_dispatch:
    inputs:
      FORCE_MODE:
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

defaults:
  run:
    shell: 'bash --noprofile --norc -Eeuo pipefail {0}'

jobs:
  core_build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: SYNC_DEPS
        run: |
          sudo apt-get update
          sudo apt-get install -y git meson ninja-build zip curl jq gh python3-venv glslang-tools

      - name: Setup llvm-mingw
        run: |
          curl -L -o llvm-mingw.tar.xz "https://github.com/mstorsjo/llvm-mingw/releases/download/20241217/llvm-mingw-20241217-ucrt-ubuntu-20.04-x86_64.tar.xz"
          tar -xf llvm-mingw.tar.xz
          echo "$PWD/llvm-mingw-20241217-ucrt-ubuntu-20.04-x86_64/bin" >> $GITHUB_PATH

      - name: FETCH_TAG
        id: info
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | jq -r .tag_name)
          echo "TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "VER=${LATEST_TAG#v}" >> $GITHUB_ENV

      - name: CHECK_EXISTENCE
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTS=$(gh release view "build-${{ env.VER }}" --repo ${{ github.repository }} > /dev/null 2>&1 && echo "true" || echo "false")
          if [[ "${{ github.event.inputs.FORCE_MODE }}" == "true" ]]; then EXISTS="false"; fi
          echo "SKIP_RUN=$EXISTS" >> $GITHUB_OUTPUT

      - name: COMPILE_SRC
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          git clone --recursive --branch ${{ env.TAG }} https://github.com/HansKristian-Work/vkd3d-proton.git src
          cd src
          ./package-release.sh ${{ env.TAG }} ../out --no-package

      - name: PREP_WCP_ROOT
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          mkdir -p staging/system32 staging/syswow64
          SRC_PATH=$(find out -maxdepth 1 -type d -name "vkd3d-proton-*")
          cp "$SRC_PATH/x64/"*.dll staging/system32/
          cp "$SRC_PATH/x86/"*.dll staging/syswow64/
          
          cat > staging/profile.json << EOF
          {
            "type": "VKD3D",
            "versionName": "${{ env.VER }}",
            "versionCode": $(date +%s),
            "description": "VKD3D-Proton ${{ env.VER }}",
            "files": [
              {"source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll"}
            ]
          }
          EOF

      - name: PACK_WCP
        if: steps.check.outputs.SKIP_RUN == 'false'
        run: |
          cd staging && zip -r "../vkd3d-proton-${{ env.VER }}.wcp" ./*

      - name: DEPLOY_RELEASE
        if: steps.check.outputs.SKIP_RUN == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.VER }}
          name: VKD3D-Proton ${{ env.VER }}
          files: "*.wcp"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
