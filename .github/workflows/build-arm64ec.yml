name: build-arm64ec

on:
  workflow_dispatch:
    inputs:
      version:
        description: version
        required: false
        default: ""
  workflow_call:
    inputs:
      version:
        type: string
        required: false
        default: ""
    outputs:
      version:
        value: ${{ jobs.build.outputs.version }}
      commit:
        value: ${{ jobs.build.outputs.commit }}
      artifact_name:
        value: ${{ jobs.build.outputs.artifact_name }}

concurrency:
  group: build-arm64ec-${{ github.ref }}-${{ inputs.version || 'latest' }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  LLVM_MINGW_VER: "20250114"
  TOOLCHAIN_DIR: "/opt/llvm-mingw"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    outputs:
      version: ${{ steps.build.outputs.version }}
      commit: ${{ steps.build.outputs.commit }}
      artifact_name: ${{ steps.package.outputs.artifact_name }}

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: cache-toolchain
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: /opt/llvm-mingw
          key: llvm-mingw-${{ env.LLVM_MINGW_VER }}

      - name: setup
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git meson ninja-build curl jq python3 \
            glslang-tools spirv-tools zstd llvm

      - name: setup-toolchain
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://github.com/mstorsjo/llvm-mingw/releases/download/${{ env.LLVM_MINGW_VER }}/llvm-mingw-${{ env.LLVM_MINGW_VER }}-ucrt-ubuntu-20.04-x86_64.tar.xz" \
            | sudo tar -xJ -C /opt
          sudo mv /opt/llvm-mingw-* ${{ env.TOOLCHAIN_DIR }}

      - name: configure-path
        run: echo "${{ env.TOOLCHAIN_DIR }}/bin" >> $GITHUB_PATH

      - name: build
        id: build
        run: |
          chmod +x scripts/build.sh
          bash scripts/build.sh "${{ inputs.version }}" arm64ec

      - name: package
        id: package
        run: |
          chmod +x scripts/package.sh
          bash scripts/package.sh "$VERSION" "$COMMIT" arm64ec

      - name: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            ${{ env.ARTIFACT_NAME }}.wcp
            package/checksums.txt
            package/profile.json
            patch-report.txt
          retention-days: 90
