name: Release Turnip Gen8 - SD 8 Elite (Android 15)

on:
  workflow_dispatch:
    inputs:
      target_device:
        description: 'Target Device (Adreno 8xx)'
        required: false
        default: 'adreno-830'
        type: choice
        options:
          - adreno-830
          - adreno-840
      enable_lrz:
        description: 'Enable LRZ (Experimental - may cause faults)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build python3-pip python3-mako \
            flex bison patchelf curl unzip clang lld llvm cmake pkg-config

      - name: Build Glslang (Vulkan Essentials)
        run: |
          git clone --depth 1 --branch 15.1.0 https://github.com/KhronosGroup/glslang.git
          cd glslang
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME/glslang_install -DENABLE_OPT=0
          cmake --build build -j$(nproc)
          cmake --install build
          echo "$HOME/glslang_install/bin" >> $GITHUB_PATH

      - name: Upgrade Meson Build System
        run: |
          pip3 install --upgrade pip
          pip3 install meson

      - name: Setup Android NDK r27
        run: |
          curl -L -o ndk.zip "https://dl.google.com/android/repository/android-ndk-r27-linux.zip"
          unzip -q ndk.zip
          echo "NDK_PATH=$PWD/android-ndk-r27" >> $GITHUB_ENV

      - name: Clone Rob Clark Gen8 Mesa
        run: |
          git clone https://gitlab.freedesktop.org/mesa/mesa.git mesa-source
          cd mesa-source
          git remote add robclark https://gitlab.freedesktop.org/robclark/mesa.git
          git fetch robclark tu/gen8
          git checkout FETCH_HEAD

      - name: Advanced Build Configuration (ARMv9 + API 35)
        run: |
          cd mesa-source
          NDK_SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          
          cat > android_cross.ini << EOF
          [binaries]
          c = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android35-clang'
          cpp = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android35-clang++'
          ar = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
          ld = 'lld'
          
          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv9-a'
          endian = 'little'
          
          [built-in options]
          c_args = ['-I$NDK_SYSROOT/usr/include', '-O3', '-march=armv9-a+crypto', '-g0']
          cpp_args = ['-I$NDK_SYSROOT/usr/include', '-O3', '-march=armv9-a+crypto', '-g0']
          c_link_args = ['-L$NDK_SYSROOT/usr/lib/aarch64-linux-android/35', '-lz']
          
          [properties]
          sys_root = '$NDK_SYSROOT'
          EOF
          
          meson setup build-android \
            --cross-file android_cross.ini \
            -Dplatforms=android \
            -Dplatform-sdk-version=35 \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dbuildtype=release \
            -Dstrip=true \
            -Dgallium-drivers= \
            -Dopengl=false \
            -Degl=disabled \
            -Dshader-cache=disabled
            
          ninja -C build-android src/freedreno/vulkan/libvulkan_freedreno.so

      - name: Prepare Final Driver Package
        run: |
          mkdir -p release_assets/turnip_package/lib64
          DEVICE="${{ github.event.inputs.target_device || 'adreno-830' }}"
          LRZ_ENABLED="${{ github.event.inputs.enable_lrz || 'false' }}"
          
          cp mesa-source/build-android/src/freedreno/vulkan/libvulkan_freedreno.so release_assets/turnip_package/lib64/vulkan.adreno.so
          
          if [ "$LRZ_ENABLED" = "false" ]; then
            LRZ_NOTE=" (LRZ disabled for stability)"
            TU_DEBUG_VALUE="nolrz"
          else
            LRZ_NOTE=" (LRZ enabled - experimental)"
            TU_DEBUG_VALUE=""
          fi
          
          cat > release_assets/turnip_package/meta.json << EOF
          {
            "schemaVersion": 1,
            "name": "Turnip Gen8 Experimental (Android 15)",
            "description": "Mesa 26.0.0-devel for ${DEVICE} (Snapdragon 8 Elite)${LRZ_NOTE}",
            "author": "Mesa-RobClark",
            "packageVersion": "26.0.0",
            "vendor": "Mesa",
            "driverVersion": "26.0.0",
            "minApi": 35,
            "libraryName": "vulkan.adreno.so",
            "tuDebug": "${TU_DEBUG_VALUE}",
            "architecture": "armv9-a"
          }
          EOF
          
          cat > release_assets/turnip_package/README.txt << EOF
          Turnip Gen8 Experimental Driver (Android 15)
          =============================================
          Target: ${DEVICE} (Snapdragon 8 Elite / Kaanapali / Glymur)
          Architecture: ARMv9-A (Oryon cores)
          Min API: 35 (Android 15)
          Based on: Rob Clark's tu/gen8 branch
          
          Build Optimizations:
          - Compiled with -march=armv9-a+crypto for SVE2 support
          - NDK r27 with LLVM 18
          - API Level 35 targeting
          
          Known Issues:
          - LRZ may cause faults (use TU_DEBUG=nolrz to disable)
          - Experimental - not all Vulkan CTS tests pass yet
          
          To disable LRZ at runtime, set environment variable:
          TU_DEBUG=nolrz
          EOF
          
          cd release_assets/turnip_package && zip -r ../turnip_gen8_${DEVICE}_android15.zip .

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: turnip-gen8-driver-android15
          path: release_assets/*.zip
