name: Advanced Turnip Builder with Auto-Patching

on:
  workflow_dispatch:
    inputs:
      mesa_branch:
        description: 'Mesa branch/tag (default: main)'
        required: false
        default: 'main'
        type: string
      target_device:
        description: 'Target Adreno device'
        required: false
        default: 'adreno-750'
        type: choice
        options:
          - adreno-730
          - adreno-740
          - adreno-750
          - generic-a6xx
          - generic-a7xx
      enable_auto_patches:
        description: 'Enable automatic patch updates'
        required: false
        default: true
        type: boolean
      optimization_level:
        description: 'Build optimization level'
        required: false
        default: 'aggressive'
        type: choice
        options:
          - balanced
          - aggressive
          - size-optimized

env:
  ANDROID_NDK_VERSION: 'r26d'
  ANDROID_API_LEVEL: '34'
  MIRROR_SOURCES:
    - 'https://gitlab.freedesktop.org/mesa/mesa.git'
    - 'https://github.com/K11MCH1/mesa.git'
    - 'https://gitlab.freedesktop.org/robclark/mesa.git'

permissions:
  contents: write

jobs:
  setup-environment:
    # Changed to 22.04 to fix "runner not found" / queuing issues
    runs-on: ubuntu-22.04
    outputs:
      mesa_source: ${{ steps.select-source.outputs.selected_source }}
      device_config: ${{ steps.device-config.outputs.config }}
    
    steps:
      - name: Install Prerequisites
        run: sudo apt-get update && sudo apt-get install -y jq curl git

      - name: Checkout with patches directory
        uses: actions/checkout@v4
        with:
          path: source
          
      - name: Setup workspace folders
        run: |
          mkdir -p ${{ github.workspace }}/cache/auto-patches
          mkdir -p ${{ github.workspace }}/source/patches/device-specific
          
      - name: Select optimal Mesa source
        id: select-source
        shell: bash
        run: |
          SOURCES=("https://gitlab.freedesktop.org/mesa/mesa.git" "https://github.com/K11MCH1/mesa.git" "https://gitlab.freedesktop.org/robclark/mesa.git")
          FASTEST_SOURCE=""
          FASTEST_TIME=999999
          
          for SOURCE in "${SOURCES[@]}"; do
            echo "Testing: $SOURCE"
            START_TIME=$(date +%s%N)
            # Lightweight check
            if git ls-remote --heads "$SOURCE" "main" >/dev/null 2>&1; then
              END_TIME=$(date +%s%N)
              TIME_MS=$(( (END_TIME - START_TIME) / 1000000 ))
              echo "Response time: ${TIME_MS}ms"
              
              if [ $TIME_MS -lt $FASTEST_TIME ]; then
                FASTEST_TIME=$TIME_MS
                FASTEST_SOURCE="$SOURCE"
              fi
            fi
          done
          
          # Fallback
          if [ -z "$FASTEST_SOURCE" ]; then
             FASTEST_SOURCE="https://gitlab.freedesktop.org/mesa/mesa.git"
          fi
          echo "selected_source=$FASTEST_SOURCE" >> $GITHUB_OUTPUT
          
      - name: Device-specific configuration
        id: device-config
        run: |
          DEVICE="${{ github.event.inputs.target_device }}"
          case $DEVICE in
            "adreno-730")
              CONFIG='{"gpu_id":"730","arch":"a6xx","kmds":["kgsl"],"patches":["tu6-optimizations","memory-tiling"],"min_api":31}'
              ;;
            "adreno-740")
              CONFIG='{"gpu_id":"740","arch":"a7xx","kmds":["kgsl"],"patches":["gen7-support","lrz-fix"],"min_api":33}'
              ;;
            "adreno-750")
              CONFIG='{"gpu_id":"750","arch":"a7xx","kmds":["msm","kgsl"],"patches":["gen8-support","lrz-layout-fix"],"min_api":34,"experimental":true}'
              ;;
            *)
              CONFIG='{"gpu_id":"generic","arch":"a6xx","kmds":["kgsl"],"patches":[],"min_api":27}'
              ;;
          esac
          echo "config=$CONFIG" >> $GITHUB_OUTPUT
          
      - name: Automatic patch discovery
        if: ${{ github.event.inputs.enable_auto_patches == 'true' }}
        run: |
          AUTO_PATCH_DIR="${{ github.workspace }}/cache/auto-patches"
          
          # 1. Fetch prefer_sysmem.patch
          curl -s -f -L "https://raw.githubusercontent.com/K11MCH1/AdrenoToolsDrivers/v26.0.0/patches/prefer_sysmem.patch" \
               -o "$AUTO_PATCH_DIR/prefer_sysmem.patch" || echo "Failed to fetch sysmem patch"

          # 2. Fetch Gen8 specific patches if needed
          DEVICE="${{ github.event.inputs.target_device }}"
          if [ "$DEVICE" = "adreno-750" ]; then
             echo "Fetching Gen8 patches..."
             curl -s -f -L "https://gitlab.freedesktop.org/robclark/mesa/-/raw/tu/gen8/patches/gen8_support.patch" \
                  -o "$AUTO_PATCH_DIR/gen8_support.patch" || true
          fi
          
          # Move to source/patches so they can be uploaded
          cp "$AUTO_PATCH_DIR"/*.patch "${{ github.workspace }}/source/patches/" 2>/dev/null || true

      # CRITICAL FIX: Upload patches as artifact so Job 2 can see them
      - name: Upload Patches Artifact
        uses: actions/upload-artifact@v4
        with:
          name: patches-bundle
          path: ${{ github.workspace }}/source/patches/
          if-no-files-found: warn

  build-turnip:
    needs: setup-environment
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      # CRITICAL FIX: Download the patches artifact from Job 1
      - name: Download Patches
        uses: actions/download-artifact@v4
        with:
          name: patches-bundle
          path: ${{ github.workspace }}/source/patches/
          
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build python3-pip python3-mako flex bison \
            patchelf curl unzip clang lld llvm libclang-dev pkg-config jq
          
          # Safe pip install
          pip3 install --upgrade meson mako
          
      - name: Setup Android NDK
        run: |
          if [ ! -d "android-ndk-${{ env.ANDROID_NDK_VERSION }}" ]; then
            curl -L -o ndk.zip "https://dl.google.com/android/repository/android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip"
            unzip -q ndk.zip
            rm ndk.zip
          fi
          echo "NDK_PATH=$PWD/android-ndk-${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
          
      - name: Clone Mesa
        run: |
          MESA_SOURCE="${{ needs.setup-environment.outputs.mesa_source }}"
          MESA_BRANCH="${{ github.event.inputs.mesa_branch }}"
          DEVICE="${{ github.event.inputs.target_device }}"
          
          echo "Cloning from $MESA_SOURCE..."
          
          if [ "$DEVICE" = "adreno-750" ]; then
             # Try specialized branch first, fallback to main
             git clone --depth 1 --branch tu/gen8 "https://gitlab.freedesktop.org/robclark/mesa.git" mesa-source || \
             git clone --depth 1 --branch "$MESA_BRANCH" "$MESA_SOURCE" mesa-source
          else
             git clone --depth 1 --branch "$MESA_BRANCH" "$MESA_SOURCE" mesa-source
          fi
          
          cd mesa-source
          echo "MESA_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          
      - name: Apply Patches
        run: |
          cd mesa-source
          DEVICE_CONFIG='${{ needs.setup-environment.outputs.device_config }}'
          REQUIRED_PATCHES=$(echo "$DEVICE_CONFIG" | jq -r '.patches[]?')
          
          echo "Required patches: $REQUIRED_PATCHES"
          
          apply_patch() {
             local name=$1
             # Look in possible paths
             local p=""
             if [ -f "../source/patches/$name" ]; then p="../source/patches/$name"; 
             elif [ -f "../source/patches/device-specific/$name" ]; then p="../source/patches/device-specific/$name"; fi
             
             if [ -n "$p" ]; then
                echo "Applying $name..."
                git apply --check "$p" 2>/dev/null && git apply "$p" || echo "⚠ Failed/Skipped $name"
             else
                echo "ℹ Patch $name not found, skipping."
             fi
          }

          for patch in $REQUIRED_PATCHES; do
             apply_patch "$patch.patch"
          done
          
          if [ "${{ github.event.inputs.enable_auto_patches }}" == "true" ]; then
             apply_patch "prefer_sysmem.patch"
          fi
          
      - name: Configure and Build
        run: |
          cd mesa-source
          DEVICE_CONFIG='${{ needs.setup-environment.outputs.device_config }}'
          GPU_ID=$(echo "$DEVICE_CONFIG" | jq -r '.gpu_id')
          KMD_LIST=$(echo "$DEVICE_CONFIG" | jq -r '.kmds | join(",")')
          
          # Optimization Flags
          OPT_FLAGS="-O2"
          if [ "${{ github.event.inputs.optimization_level }}" == "aggressive" ]; then
            OPT_FLAGS="-O3 -flto=thin"
            if [ "$GPU_ID" == "750" ]; then OPT_FLAGS="$OPT_FLAGS -march=armv8.5-a -Dtu-max-vertices=2147483647"; fi
            if [ "$GPU_ID" == "740" ]; then OPT_FLAGS="$OPT_FLAGS -march=armv8.4-a"; fi
          elif [ "${{ github.event.inputs.optimization_level }}" == "size-optimized" ]; then
            OPT_FLAGS="-Oz"
          fi
          
          # Create cross file
          cat > android_cross.ini << EOF
          [binaries]
          c = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-clang'
          cpp = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-clang++'
          ar = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
          ld = 'lld'
          pkgconfig = 'pkg-config'
          [properties]
          c_args = ['$OPT_FLAGS']
          cpp_args = ['$OPT_FLAGS']
          c_link_args = ['$OPT_FLAGS', '-fuse-ld=lld']
          cpp_link_args = ['$OPT_FLAGS', '-fuse-ld=lld']
          needs_exe_wrapper = true
          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          EOF
          
          # Configure Meson
          meson setup build-android \
            --cross-file android_cross.ini \
            --buildtype release \
            -Dplatforms=android \
            -Dplatform-sdk-version=${{ env.ANDROID_API_LEVEL }} \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=$KMD_LIST \
            -Dgallium-drivers= \
            -Dstrip=true \
            -Dglx=disabled \
            -Degl=disabled \
            -Dopengl=false \
            -Dgles1=disabled \
            -Dgles2=disabled \
            -Dshared-glapi=disabled \
            -Dtools=
            
          # Compile
          ninja -C build-android src/freedreno/vulkan/libvulkan_freedreno.so

      - name: Package and Release
        run: |
          mkdir -p output
          DEVICE="${{ github.event.inputs.target_device }}"
          MESA_COMMIT="${{ env.MESA_COMMIT }}"
          
          cp mesa-source/build-android/src/freedreno/vulkan/libvulkan_freedreno.so \
             "output/vulkan.${DEVICE}.${MESA_COMMIT}.so"
          
          cd output
          zip -9 "turnip-${DEVICE}-${MESA_COMMIT}.zip" *
          sha256sum "turnip-${DEVICE}-${MESA_COMMIT}.zip" > "turnip-${DEVICE}-${MESA_COMMIT}.sha256"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: turnip-${{ github.event.inputs.target_device }}-${{ env.MESA_COMMIT }}
          path: output/*

      - name: GitHub Release
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: turnip-${{ github.event.inputs.target_device }}-${{ env.MESA_COMMIT }}
          name: "Turnip ${{ github.event.inputs.target_device }} (${{ env.MESA_COMMIT }})"
          files: output/*
