name: Build Turnip - Adreno 8XX (A8XX)

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  MESA_VERSION: "26.0.0"
  BUILD_TAG: "devel"
  NDK_VERSION: "r29"
  API_LEVEL: "34"

jobs:
  get-mesa-info:
    runs-on: ubuntu-24.04
    outputs:
      commit_sha: ${{ steps.mesa.outputs.sha }}
      commit_date: ${{ steps.mesa.outputs.date }}
      vulkan_version: ${{ steps.mesa.outputs.vulkan }}
    steps:
      - name: Get Mesa Gen8 Branch Info
        id: mesa
        run: |
          git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git remote add robclark https://gitlab.freedesktop.org/robclark/mesa.git
          git fetch robclark tu/gen8 --depth 1
          git checkout FETCH_HEAD
          
          SHA=$(git rev-parse --short HEAD)
          DATE=$(git log -1 --format=%cd --date=short)
          VK_VERSION=$(grep -oP "vk_api_version\s*=\s*'\K[^']+" meson.build 2>/dev/null || echo "1.4")
          
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "vulkan=$VK_VERSION" >> $GITHUB_OUTPUT
          
          echo "=========================================="
          echo "  Mesa Gen8 Branch Info"
          echo "=========================================="
          echo "Commit: $SHA"
          echo "Date: $DATE"
          echo "Vulkan: $VK_VERSION"
          echo "=========================================="

  build-turnip:
    needs: get-mesa-info
    runs-on: ubuntu-24.04
    outputs:
      build_date: ${{ steps.set-date.outputs.build_date }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Build Date
        id: set-date
        run: echo "build_date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build python3-pip python3-mako \
            flex bison patchelf curl unzip clang lld llvm cmake pkg-config
          pip install meson mako

      - name: Setup NDK
        run: |
          curl -sL -o ndk.zip "https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip"
          unzip -q ndk.zip
          echo "NDK=$(pwd)/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Clone Mesa
        run: |
          echo "Cloning Mesa from Gen8 branch..."
          git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git remote add robclark https://gitlab.freedesktop.org/robclark/mesa.git
          git fetch robclark tu/gen8 --depth 1
          git checkout FETCH_HEAD
          echo "Commit: $(git rev-parse --short HEAD)"

      - name: Configure Meson
        run: |
          cd mesa
          
          cat > cross.ini << EOF
          [binaries]
          c = ['aarch64-linux-android${{ env.API_LEVEL }}-clang']
          cpp = ['aarch64-linux-android${{ env.API_LEVEL }}-clang++']
          ar = ['llvm-ar']
          strip = ['llvm-strip']
          ld = ['lld']
          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          EOF
          
          export PATH="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          SYSROOT="$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          
          PERF_FLAGS="-O3 -flto=full -ffast-math -fno-signed-zeros -fno-trapping-math -fomit-frame-pointer -funroll-loops -ftree-vectorize -fno-stack-protector -march=armv8.5-a"
          LTO_MODE="full"
          
          C_ARGS="-DA8XX_ENABLED=1 -DENABLE_GEN8=1 -DTU_DEFAULT_GMEM=1 -DTU_AGGRESSIVE_PREFETCH=1 -DNDEBUG"
          
          meson setup build --cross-file cross.ini \
            -Dplatforms=android \
            -Dplatform-sdk-version=${{ env.API_LEVEL }} \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dbuildtype=release \
            -Dstrip=true \
            -Db_lto=true \
            -Dc_args="-I$SYSROOT/usr/include $PERF_FLAGS -g0 $C_ARGS" \
            -Dcpp_args="-I$SYSROOT/usr/include $PERF_FLAGS -g0 $C_ARGS" \
            -Dc_link_args="-L$SYSROOT/usr/lib/aarch64-linux-android/${{ env.API_LEVEL }} -lz -flto=$LTO_MODE" \
            -Dcpp_link_args="-L$SYSROOT/usr/lib/aarch64-linux-android/${{ env.API_LEVEL }} -lz -flto=$LTO_MODE"

      - name: Build
        run: |
          export PATH="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          ninja -C mesa/build src/freedreno/vulkan/libvulkan_freedreno.so

      - name: Check and Reduce Library Size
        run: |
          LIB_PATH="mesa/build/src/freedreno/vulkan/libvulkan_freedreno.so"
          
          echo "=== Original File Size ==="
          ls -lh "$LIB_PATH"
          
          echo "=== Stripping Debug Symbols ==="
          $NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip --strip-unneeded "$LIB_PATH"
          
          echo "=== File Size After Strip ==="
          ls -lh "$LIB_PATH"
          
          MIN_SIZE_MB=16
          ACTUAL_SIZE_BYTES=$(stat -c%s "$LIB_PATH")
          ACTUAL_SIZE_MB=$((ACTUAL_SIZE_BYTES / 1024 / 1024))
          
          echo "Minimum required size: ${MIN_SIZE_MB}MB"
          echo "Actual size after strip: ${ACTUAL_SIZE_MB}MB"
          
          if [ $ACTUAL_SIZE_MB -ge $MIN_SIZE_MB ]; then
            echo "SUCCESS: Library meets the minimum size requirement."
          else
            echo "WARNING: Library size (${ACTUAL_SIZE_MB}MB) is below the minimum (${MIN_SIZE_MB}MB)."
            echo "This may indicate an incomplete or failed build. Consider checking the build logs."
          fi

      - name: Package
        run: |
          mkdir -p release/out
          cp mesa/build/src/freedreno/vulkan/libvulkan_freedreno.so release/out/vulkan.ad08XX.so
          
          CURRENT_DATE=$(date +'%b-%d-%Y' | tr '[:upper:]' '[:lower:]')
          ARCHIVE_NAME="turnip_v${{ env.MESA_VERSION }}_${{ env.BUILD_TAG }}_$CURRENT_DATE.zip"
          
          cat > release/out/meta.json << EOF
          {
            "schemaVersion": 1,
            "name": "$ARCHIVE_NAME",
            "description": "",
            "author": "KIMCHI, Mesa",
            "packageVersion": "${{ env.MESA_VERSION }}",
            "vendor": "Mesa",
            "driverVersion": "Vulkan ${{ needs.get-mesa-info.outputs.vulkan_version }}",
            "minApi": ${{ env.API_LEVEL }},
            "libraryName": "vulkan.ad08XX.so"
          }
          EOF
          
          cd release/out && zip -r "../$ARCHIVE_NAME" .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_TAG }}-${{ github.run_id }}
          path: release/turnip_v${{ env.MESA_VERSION }}_${{ env.BUILD_TAG }}_*.zip
          retention-days: 5

  release:
    needs: [get-mesa-info, build-turnip]
    runs-on: ubuntu-24.04
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.BUILD_TAG }}-${{ github.run_id }}
          path: dist

      - name: Generate Checksum
        run: |
          cd dist
          ARCHIVE_NAME=$(ls *.zip)
          sha256sum "$ARCHIVE_NAME" > "${ARCHIVE_NAME}.sha256"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_id }}
          name: "Build ${{ github.run_id }}"
          body: |
            Automated Turnip Build from Gen8 Branch
            
            Build Information:
            - Build ID: ${{ github.run_id }}
            - Mesa Branch: robclark/tu/gen8
            - Mesa Commit: ${{ needs.get-mesa-info.outputs.commit_sha }}
            - Vulkan Version: ${{ needs.get-mesa-info.outputs.vulkan_version }}
            - API Level: ${{ env.API_LEVEL }}
            - Build Date: ${{ needs.build-turnip.outputs.build_date }}
            
            File Information:
            Check meta.json inside the archive for details.
            
          files: |
            dist/*.zip
            dist/*.sha256
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
