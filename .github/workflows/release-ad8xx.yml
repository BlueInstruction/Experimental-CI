name: "[Build] Turnip for Adreno 8XX (A8XX)"

on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    # æ·»åŠ ä¸€ä¸ªè¾“å…¥å‚æ•°ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼Œä¹Ÿæœ‰åŠ©äºâ€œæ¿€æ´»â€å·¥ä½œæµ
    inputs:
      build_note:
        description: 'æ·»åŠ æœ¬æ¬¡æ„å»ºçš„å¤‡æ³¨ (å¯é€‰)'
        required: false
        default: 'æ—¥å¸¸æ„å»º'

permissions:
  contents: write

env:
  MESA_VERSION: "26.0.0"
  BUILD_TAG: "devel-a8xx"
  NDK_VERSION: "r29"
  API_LEVEL: "34"

jobs:
  get-mesa-info:
    runs-on: ubuntu-24.04
    outputs:
      commit_sha: ${{ steps.mesa.outputs.sha }}
      commit_date: ${{ steps.mesa.outputs.date }}
      vulkan_version: ${{ steps.mesa.outputs.vulkan }}
    steps:
      - name: 1. è·å– Mesa Gen8 åˆ†æ”¯ä¿¡æ¯
        id: mesa
        run: |
          git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git remote add robclark https://gitlab.freedesktop.org/robclark/mesa.git
          git fetch robclark tu/gen8 --depth 1
          git checkout FETCH_HEAD
          
          SHA=$(git rev-parse --short HEAD)
          DATE=$(git log -1 --format=%cd --date=short)
          VK_VERSION=$(grep -oP "vk_api_version\s*=\s*'\K[^']+" meson.build 2>/dev/null || echo "1.4")
          
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "vulkan=$VK_VERSION" >> $GITHUB_OUTPUT
          
          echo "=========================================="
          echo "  Mesa Gen8 Branch Info"
          echo "=========================================="
          echo "Commit: $SHA"
          echo "Date: $DATE"
          echo "Vulkan: $VK_VERSION"
          echo "=========================================="

  build-turnip:
    needs: get-mesa-info
    runs-on: ubuntu-24.04
    steps:
      - name: 2. å‡†å¤‡ä»“åº“
        uses: actions/checkout@v4

      - name: 3. å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build python3-pip python3-mako \
            flex bison patchelf curl unzip clang lld llvm cmake pkg-config

      - name: 4. è®¾ç½® Android NDK
        run: |
          curl -sL -o ndk.zip "https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip"
          unzip -q ndk.zip
          echo "NDK=$(pwd)/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: 5. å…‹éš†å¹¶åˆ‡æ¢åˆ°æŒ‡å®š Mesa æäº¤
        run: |
          echo "æ­£åœ¨å…‹éš† Mesa (Gen8 åˆ†æ”¯)..."
          # æ³¨æ„ï¼šè¿™é‡Œç›´æ¥å…‹éš† robclark çš„ä»“åº“å’Œç‰¹å®šåˆ†æ”¯ï¼Œæ›´ç›´æ¥
          git clone --depth 1 -b tu/gen8 https://gitlab.freedesktop.org/robclark/mesa.git mesa_gen8
          cd mesa_gen8
          echo "å½“å‰æäº¤: $(git rev-parse --short HEAD)"

      - name: 6. é…ç½® Meson æ„å»ºç³»ç»Ÿ
        run: |
          cd mesa_gen8
          
          # åˆ›å»ºäº¤å‰ç¼–è¯‘é…ç½®æ–‡ä»¶
          cat > cross.ini << EOF
          [binaries]
          c = ['aarch64-linux-android${{ env.API_LEVEL }}-clang']
          cpp = ['aarch64-linux-android${{ env.API_LEVEL }}-clang++']
          ar = ['llvm-ar']
          strip = ['llvm-strip']
          ld = ['lld']
          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          EOF
          
          export PATH="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          SYSROOT="$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          
          # æ€§èƒ½ä¼˜åŒ–æ ‡å¿—
          PERF_FLAGS="-O3 -flto=full -ffast-math -fno-signed-zeros -fno-trapping-math -fomit-frame-pointer -funroll-loops -ftree-vectorize -fno-stack-protector -march=armv8.5-a"
          
          # A8XX ç‰¹å®šæ„å»ºæ ‡å¿—
          C_ARGS="-DA8XX_ENABLED=1 -DENABLE_GEN8=1 -DTU_DEFAULT_GMEM=1 -DTU_AGGRESSIVE_PREFETCH=1 -DNDEBUG"
          
          # è¿è¡Œ meson é…ç½®
          meson setup build --cross-file cross.ini \
            -Dplatforms=android \
            -Dplatform-sdk-version=${{ env.API_LEVEL }} \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dbuildtype=release \
            -Dstrip=true \
            -Db_lto=true \
            -Dc_args="-I$SYSROOT/usr/include $PERF_FLAGS -g0 $C_ARGS" \
            -Dcpp_args="-I$SYSROOT/usr/include $PERF_FLAGS -g0 $C_ARGS" \
            -Dc_link_args="-L$SYSROOT/usr/lib/aarch64-linux-android/${{ env.API_LEVEL }} -lz -flto=full"

      - name: 7. ç¼–è¯‘ Turnip é©±åŠ¨
        run: |
          export PATH="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          ninja -C mesa_gen8/build src/freedreno/vulkan/libvulkan_freedreno.so

      - name: 8. æ£€æŸ¥å¹¶ä¼˜åŒ–åº“æ–‡ä»¶å¤§å°
        run: |
          LIB_PATH="mesa_gen8/build/src/freedreno/vulkan/libvulkan_freedreno.so"
          
          echo "=== åŸå§‹æ–‡ä»¶å¤§å° ==="
          ls -lh "$LIB_PATH"
          
          echo "=== å‰¥ç¦»è°ƒè¯•ç¬¦å· ==="
          $NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip --strip-unneeded "$LIB_PATH"
          
          echo "=== å‰¥ç¦»åæ–‡ä»¶å¤§å° ==="
          ls -lh "$LIB_PATH"
          
          MIN_SIZE_MB=16
          ACTUAL_SIZE_BYTES=$(stat -c%s "$LIB_PATH")
          ACTUAL_SIZE_MB=$((ACTUAL_SIZE_BYTES / 1024 / 1024))
          
          echo "æœ€ä½è¦æ±‚å¤§å°: ${MIN_SIZE_MB}MB"
          echo "å®é™…å¤§å°: ${ACTUAL_SIZE_MB}MB"
          
          if [ $ACTUAL_SIZE_MB -ge $MIN_SIZE_MB ]; then
            echo "âœ… æˆåŠŸ: åº“æ–‡ä»¶æ»¡è¶³æœ€å°å¤§å°è¦æ±‚ã€‚"
          else
            echo "âš ï¸  è­¦å‘Š: åº“æ–‡ä»¶å¤§å°(${ACTUAL_SIZE_MB}MB) ä½äºæœ€ä½è¦æ±‚(${MIN_SIZE_MB}MB)ã€‚"
            echo "   è¿™å¯èƒ½è¡¨ç¤ºæ„å»ºä¸å®Œæ•´ï¼Œå»ºè®®æ£€æŸ¥æ„å»ºæ—¥å¿—ã€‚"
          fi

      - name: 9. æ‰“åŒ…ç”Ÿæˆæ–‡ä»¶
        run: |
          mkdir -p release/out
          cp mesa_gen8/build/src/freedreno/vulkan/libvulkan_freedreno.so release/out/vulkan.ad08XX.so
          
          CURRENT_DATE=$(date +'%b-%d-%Y' | tr '[:upper:]' '[:lower:]')
          ARCHIVE_NAME="turnip_v${{ env.MESA_VERSION }}_${{ env.BUILD_TAG }}_$CURRENT_DATE.zip"
          
          # åˆ›å»º meta.json æ–‡ä»¶
          cat > release/out/meta.json << EOF
{
  "schemaVersion": 1,
  "name": "$ARCHIVE_NAME",
  "description": "Turnip driver for Adreno 8XX (A8XX) built from robclark/tu/gen8 branch",
  "author": "Mesa, KIMCHI",
  "packageVersion": "${{ env.MESA_VERSION }}-${{ env.BUILD_TAG }}",
  "vendor": "Mesa",
  "driverVersion": "Vulkan ${{ needs.get-mesa-info.outputs.vulkan_version }}",
  "minApi": ${{ env.API_LEVEL }},
  "libraryName": "vulkan.ad08XX.so",
  "buildCommit": "${{ needs.get-mesa-info.outputs.commit_sha }}",
  "buildDate": "${{ needs.get-mesa-info.outputs.commit_date }}"
}
EOF
          
          # åˆ›å»ºZIPå‹ç¼©åŒ…
          cd release/out && zip -r "../$ARCHIVE_NAME" .

      - name: 10. ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: turnip-a8xx-${{ github.run_id }}
          path: release/turnip_v${{ env.MESA_VERSION }}_${{ env.BUILD_TAG }}_*.zip
          retention-days: 7

  # å‘å¸ƒåˆ° GitHub Releases
  release:
    needs: [get-mesa-info, build-turnip]
    runs-on: ubuntu-24.04
    # åªæœ‰å½“æ‰‹åŠ¨è§¦å‘ä¸”ä¸æ˜¯ä»forkè¿è¡Œæ—¶æ‰åˆ›å»ºå‘å¸ƒ
    if: github.event_name == 'workflow_dispatch' && github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: turnip-a8xx-*
          path: dist
          merge-multiple: true

      - name: ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶
        run: |
          cd dist
          for file in *.zip; do
            sha256sum "$file" > "${file}.sha256"
            echo "ä¸º $file ç”Ÿæˆæ ¡éªŒå’Œ"
          done

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "turnip-a8xx-${{ github.run_id }}"
          name: "Turnip for Adreno 8XX - Build #${{ github.run_id }}"
          body: |
            ## ğŸš€ Turnip Vulkan é©±åŠ¨ for Adreno 8XX (A8XX)
            
            **æ„å»ºä¿¡æ¯**
            - æ„å»ºID: `${{ github.run_id }}`
            - æ„å»ºæ—¥æœŸ: $(date -u +'%Y-%m-%d %H:%M UTC')
            - ç”¨æˆ·å¤‡æ³¨: ${{ github.event.inputs.build_note }}
            
            **æºç ä¿¡æ¯**
            - Mesa åˆ†æ”¯: `robclark/tu/gen8`
            - æäº¤å“ˆå¸Œ: `${{ needs.get-mesa-info.outputs.commit_sha }}`
            - æäº¤æ—¥æœŸ: `${{ needs.get-mesa-info.outputs.commit_date }}`
            - Vulkan API: `${{ needs.get-mesa-info.outputs.vulkan_version }}`
            
            **æŠ€æœ¯è¦æ±‚**
            - æœ€ä½ Android API: ${{ env.API_LEVEL }}
            - åº“æ–‡ä»¶å: `vulkan.ad08XX.so`
            
            **ä½¿ç”¨è¯´æ˜**
            1. è§£å‹æ­¤ZIPæ–‡ä»¶
            2. å°† `vulkan.ad08XX.so` æ”¾ç½®åˆ°è®¾å¤‡çš„æ­£ç¡®ç›®å½•
            3. ç¡®ä¿è®¾å¤‡æ»¡è¶³æœ€ä½APIçº§åˆ«è¦æ±‚
            
            **æ ¡éªŒå’Œ**
            ä¸‹è½½åè¯·ä½¿ç”¨é™„å¸¦çš„ `.sha256` æ–‡ä»¶éªŒè¯å®Œæ•´æ€§ã€‚
            
          files: |
            dist/*.zip
            dist/*.sha256
          draft: false
          prerelease: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
