name: Build Mesa Turnip v25.3.3 Android

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            ninja-build meson python3-pip python3-mako flex bison \
            glslang-tools spirv-tools patchelf curl unzip git
          pip3 install --user --upgrade meson mako
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Download Android NDK r26d
        run: |
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip -q ndk.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV

      - name: Create Android cross file
        run: |
          cat > android-aarch64 << EOF
          [binaries]
          c = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android29-clang'
          cpp = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android29-clang++'
          ar = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'

          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'

          [properties]
          c_args = ['-march=armv8.5-a', '-mtune=cortex-x4', '-O3', '-fno-plt']
          cpp_args = ['-march=armv8.5-a', '-mtune=cortex-x4', '-O3', '-fno-plt']
          EOF

      - name: Clone Mesa 25.3.3
        run: |
          git clone --branch mesa-25.3.3 https://gitlab.freedesktop.org/mesa/mesa.git mesa
          cd mesa
          echo "MESA_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Apply inline patches and environment overrides
        run: |
          cd mesa
          TARGET_FILE="src/freedreno/vulkan/tu_instance.c"
          if [ ! -f "$TARGET_FILE" ]; then
              echo "ERROR: $TARGET_FILE not found!"
              exit 1
          fi

          # Ensure #include <stdlib.h> is present for setenv
          if ! grep -q '#include <stdlib.h>' "$TARGET_FILE"; then
              sed -i '/#include/ a #include <stdlib.h>' "$TARGET_FILE"
          fi

          # Inject environment overrides after the API version line
          sed -i '/instance->api_version = tu_instance_api_version(pCreateInfo);/a \
          \
          if (!getenv("FD_DEV_FEATURES")) { setenv("FD_DEV_FEATURES", "enable_tp_ubwc_flag_hint=1", 1); } \
          if (!getenv("MESA_SHADER_CACHE_MAX_SIZE")) { setenv("MESA_SHADER_CACHE_MAX_SIZE", "1024M", 1); } \
          if (!getenv("TU_DEBUG")) { setenv("TU_DEBUG", "force_unaligned_device_local", 1); }' "$TARGET_FILE"

          # Apply extra patches (optional)
          curl -L -o prefer_sysmem.patch https://raw.githubusercontent.com/K11MCH1/AdrenoToolsDrivers/main/patches/prefer_sysmem.patch || true
          git apply prefer_sysmem.patch || true

      - name: Configure Mesa
        run: |
          cd mesa
          meson setup build-android \
            --cross-file ../android-aarch64 \
            -Dplatforms=android \
            -Dplatform-sdk-version=29 \
            -Dandroid-stub=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dgallium-drivers= \
            -Dbuildtype=release \
            -Db_lto=true \
            -Dstrip=true \
            -Dglx=disabled \
            -Degl=disabled \
            -Dopengl=false

      - name: Build Turnip
        run: |
          cd mesa
          ninja -C build-android
          cp build-android/src/freedreno/vulkan/libvulkan_freedreno.so ../vulkan.ad07xx.so

      - name: Create meta.json with features
        run: |
          cat > meta.json << EOF
          {
            "schemaVersion": 1,
            "name": "Mesa Turnip",
            "vendor": "Mesa",
            "driver": "turnip",
            "minApi": 29,
            "libraryName": "vulkan.ad07xx.so",
            "features": [
              "Environment overrides to enable:",
              "- UBWC hints (FD_DEV_FEATURES)",
              "- Large shader cache (MESA_SHADER_CACHE_MAX_SIZE=1024M)",
              "- Force unaligned device-local memory (TU_DEBUG)",
              "Optimized build flags for Adreno 750 (-O3, -march=armv8.5-a, -mtune=cortex-x4)",
              "Full cross-compilation support for Android API level 29",
              "Packaged output with vulkan.ad07xx.so and metadata"
            ]
          }
          EOF

      - name: Package Mesa Turnip
        run: |
          zip -9 mesa-v25.3.3-android.zip vulkan.ad07xx.so meta.json

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: mesa-25.3.3-${{ env.MESA_COMMIT }}
          name: Mesa Turnip v25.3.3 Android
          files: mesa-v25.3.3-android.zip
