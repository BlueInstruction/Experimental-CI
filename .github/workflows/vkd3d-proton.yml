name: build vkd3d-proton x86_64

on:
  workflow_dispatch:
    inputs:
      version:
        description: "version (empty = latest)"
        required: false
        default: ""
  workflow_call:
    inputs:
      version:
        type: string
        required: false
        default: ""
    outputs:
      version:
        value: ${{ jobs.build.outputs.version }}
      commit:
        value: ${{ jobs.build.outputs.commit }}
      artifact_name:
        value: ${{ jobs.build.outputs.artifact_name }}

concurrency:
  group: vkd3d-proton-${{ github.ref }}-${{ inputs.version || 'latest' }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.clone.outputs.commit }}
      artifact_name: ${{ steps.package.outputs.artifact_name }}

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup environment
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git meson ninja-build curl jq python3 \
            glslang-tools spirv-tools zstd \
            gcc-mingw-w64-x86-64 gcc-mingw-w64-i686 \
            g++-mingw-w64-x86-64 g++-mingw-w64-i686 \
            mingw-w64 mingw-w64-tools binutils-mingw-w64
          sudo update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix 2>/dev/null || true
          sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix 2>/dev/null || true
          sudo update-alternatives --set i686-w64-mingw32-gcc /usr/bin/i686-w64-mingw32-gcc-posix 2>/dev/null || true
          sudo update-alternatives --set i686-w64-mingw32-g++ /usr/bin/i686-w64-mingw32-g++-posix 2>/dev/null || true

      - name: get version
        id: version
        run: |
          if [[ -n "${{ inputs.version }}" ]]; then
            ver="${{ inputs.version }}"
            [[ "$ver" =~ ^v ]] || ver="v$ver"
          else
            ver=$(curl -sl https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | jq -r '.tag_name // empty')
            [[ -z "$ver" ]] && ver=$(curl -sl https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases | jq -r '.[0].tag_name')
          fi
          echo "tag=$ver" >> $github_env
          echo "version=${ver#v}" >> $github_output

      - name: clone source
        id: clone
        run: |
          git clone --branch ${{ env.tag }} --depth 1 https://github.com/HansKristian-Work/vkd3d-proton.git src
          cd src
          git submodule update --init --recursive --depth 1 --jobs 4
          commit=$(git rev-parse --short=8 head)
          commit_count=$(git rev-list --count head 2>/dev/null || echo "0")
          echo "commit=$commit" >> $github_output
          echo "commit=$commit" >> $github_env
          echo "commit_count=$commit_count" >> $github_env

      - name: apply patches
        run: python3 vkd3d-patches.py src --arch x86_64 --report

      - name: upload patch report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: patch-report-x86_64-${{ steps.version.outputs.version }}-${{ steps.clone.outputs.commit }}
          path: patch-report.txt
          retention-days: 7

      - name: build
        run: |
          cd src
          chmod +x ./package-release.sh
          export cflags="-o3 -march=x86-64 -mtune=generic -msse4.2 -mavx -mavx2 -mfma -ffast-math -dndebug"
          export cxxflags="$cflags"
          export ldflags="-s -wl,--gc-sections"
          bash ./package-release.sh ${{ env.tag }} ../out --no-package

      - name: verify build
        run: |
          src=$(find out -maxdepth 1 -type d -name "vkd3d-proton-*" | head -1)
          [[ -z "$src" ]] && { echo "build output not found"; exit 1; }
          for arch in x64 x86; do
            for dll in d3d12.dll d3d12core.dll; do
              dll_path="$src/$arch/$dll"
              if [[ ! -f "$dll_path" ]]; then
                echo "missing: $dll_path"
                exit 1
              fi
              echo "$dll_path: $(stat -c%s "$dll_path") bytes"
            done
          done
          echo "src_path=$src" >> $github_env

      - name: package
        id: package
        run: |
          version="${{ steps.version.outputs.version }}"
          commit="${{ env.commit }}"
          artifact_name="vkd3d-proton-${version}-${commit}"

          mkdir -p pkg/system32 pkg/syswow64
          cp "${{ env.src_path }}/x64/"*.dll pkg/system32/
          cp "${{ env.src_path }}/x86/"*.dll pkg/syswow64/

          cd pkg
          sha256sum system32/*.dll syswow64/*.dll > checksums.txt

          cat > profile.json << eof
          {
            "type": "vkd3d",
            "versionname": "vkd3d-proton ${version}",
            "versioncode": ${{ env.commit_count }},
            "description": "vkd3d-proton ${version} (${commit})",
            "files": [
              {"source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll"}
            ]
          }
          eof

          tar --zstd -cf "../${artifact_name}.wcp" .
          echo "artifact_name=$artifact_name" >> $github_output

      - name: upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.artifact_name }}
          path: |
            ${{ steps.package.outputs.artifact_name }}.wcp
            pkg/checksums.txt
          retention-days: 30
